= Building a versioned REST API with Phoenix Framework

I've been playing http://elixir-lang.org/:[Elixir] lately and I gotta say the more I toy with it, the more I love it.

Erglang syntax is simple, concise and easy to understand but Elixir is that and much more. In one word, *Beautiful*, it's like Ruby's cute new little sister.

I've also been toying with http://www.phoenixframework.org/:[Phoenix Framework] which is a great framework to build blazing fast web applications with Elixir.

This time, in order to learn the language and the framework, I decided to build a REST API for a personal project.

=== Dependencies

I will assume you have the following already installed in your system:

  * PostgreSQL (http://www.postgresql.org/download/:[Installing PostgreSQL])
  * Elixir (http://elixir-lang.org/install.html:[Installing Elixir])
  * Phoenix Framework (http://www.phoenixframework.org/v0.13.0/docs/up-and-running:[Installing Phoenix Framework])

=== Getting started

To create a new phoenix project run:

----
$ mix phoenix.new rest_api --no-brunch
----

where `rest_api` will be the folder of our project. Phoenix also accept an absolute path to a folder. The `--no-brunch` flag tells `phoenix.new` task we don't want to use `brunch.io` for our static asset compilation.


You'll be prompted if you want to install mix dependencies, which we should do.

----
Install mix dependencies? [Yn] Y
----

Done. You can now access the folder Phoenix created for our project.

Once mix dependencies are installed, the task will prompt you to change into the project directory and start the application.

Let's remove all auto-generated files Phoenix created for us and start from scratch.

----
$ rm web/controllers/page_controller.ex web/views/page_view.ex test/controllers/page_controller_test.exs test/views/page_view_test.exs
----

Now let's start building our API resources.

=== Generating API resources

Phoenix ships with tasks to generate resources for us. These tasks are:

  * http://hexdocs.pm/phoenix/Mix.Tasks.Phoenix.Gen.Html.html:[phoenix.gen.html]
  * http://hexdocs.pm/phoenix/Mix.Tasks.Phoenix.Gen.Json.html:[phoenix.gen.json]
  * http://hexdocs.pm/phoenix/Mix.Tasks.Phoenix.Gen.Model.html:[phoenix.gen.model]

The one we're really interested here is `phoenix.gen.json`.

Let's create a new resource called `posts`:

----
$ mix phoenix.gen.json Post posts title:string content:string
----

This will generate:

  * A model `web/models/post.ex`.
  * A model test file `test/models/post_test.exs`.
  * A migration file in `priv/repo/migrations/20150516125431_create_post.exs`
  * A post view `web/views/post_view.ex`.
  * A changeset view `web/views/changeset_view.ex`.
  * A controller `web/controllers/post_controller.ex`.
  * A controller test file in `test/controllers/post_controller_test.exs`.

It will also prompt you with a few instructions to update the router `web/router.ex` and to run the migrations. Let's do that now.

Open `web/router.ex` and change it to this:

[source,elixir]
----
defmodule RestApi.Router do
  use RestApi.Web, :router

  pipeline :api do
    plug :accepts, ["json"]
  end

  scope "/", RestApi do
    pipe_through :api

    scope "/v1", V1, as: :v1 do
      resources "/posts", PostController
    end
  end
end
----

We got rid of a lot of code we're not using for an API. We added the resource `"/posts"` within the `"/v1"` scope and we setup the `:api` pipeline within `"/"` scope.

Now let's create our development database and run the migration:

----
$ mix ecto.create
$ mix ecto.migrate
----

If you're seeing an error while executing any of these commands, you need to make sure you have PostgreSQL running and you have a role _"postgres"_ with password _"postgres"_ created. If you want to change the database configuration you can change it in `config/dev.ex` line 32-33.

If everything runs okay, you should see something like this:

----
$ mix ecto.create
...
The database for RestApi.Repo has been created.
$ mix ecto.migrate
[info] == Running RestApi.Repo.Migrations.CreatePost.change/0 forward
[info] create table posts
[info] == Migrated in 0.1s
----

Now we need to version our controllers and views. First let's create some folders and move the files:

----
$ mkdir -p web/controllers/v1
$ mv web/controllers/post_controller.ex web/controllers/v1
$ mkdir -p web/views/v1
$ mv web/views/post_view.ex web/views/v1
$ mkdir -p test/controllers/v1
$ mv test/controllers/post_controller_test.exs test/controllers/v1/
----

Now we need to add `V1` in the module name for each file, like this:

[source,elixir]
----
# web/controllers/v1/post_controller.ex
defmodule RestApi.V1.PostController
...
end

# test/controllers/v1/post_controller_test.exs
defmodule RestApi.V1.PostControllerTest do
...
end

# web/views/v1/post_view.ex
defmodule RestApi.V1.PostView do
...
end
----